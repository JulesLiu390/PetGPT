# MEMORY.md — 记忆系统定义

## 是什么

MEMORY.md 是宠物的 **长期记忆文件**，存储跨会话需要保留的重要信息：关键对话、决策、事件、用户的心情变化等。

与 USER.md 不同：USER.md 记录"主人是谁"，MEMORY.md 记录"我们之间发生了什么"。

> **替换现有系统**：MEMORY.md 取代了现有 `pets.user_memory` JSON key-value 中的事件类记忆，
> 以及 `longTimeMemory()` / `processMemory()` 的额外 LLM 调用链。
> 新方案中 AI 通过 function calling 的 `edit` 工具直接自主管理记忆，无需前端代码做判断。

## 设计意图

- 让宠物具备 **跨会话记忆** — 今天聊的明天还记得
- AI **完全自主管理** — 决定记什么、忘什么
- 记忆有 **容量意识** — 不会无限膨胀，需要定期整理
- 用户可以直接查看/编辑 — 透明可审

## 文件位置

```
~/.app/workspace/MEMORY.md
```

## 默认模板

```markdown
# 🧠 记忆

<!-- 重要的事情记在这里。这是你的长期记忆。 -->

## 重要事件

<!-- 值得记住的事情 -->

## 偏好与习惯

<!-- 从对话中观察到的主人的偏好 -->

## 待办与承诺

<!-- 答应过主人的事情、未完成的任务 -->

## 笔记

<!-- 其他值得记住的信息 -->

---

_记住重要的事，忘掉不重要的。定期整理，保持精炼。_
```

## 记忆分类

| 类别 | 写入触发 | 保留策略 | 示例 |
|------|----------|----------|------|
| **重要事件** | 对话中发生了有意义的事 | 长期保留 | "2026-02-13：主人说这周五要面试" |
| **偏好与习惯** | 多次观察到的规律 | 长期保留，可合并更新 | "主人通常晚上 10 点后活跃" |
| **待办与承诺** | AI 答应了什么 / 用户交待了什么 | 完成后移除或标记 | "提醒主人周五准备面试" |
| **笔记** | 任何其他值得记的信息 | 按需保留 | "主人给同事推荐了 Rust 学习资料" |

## 写入策略

### AI 何时写入 MEMORY.md

| 时机 | 条件 | 操作 |
|------|------|------|
| **用户明确要求** | "记住这个" / "别忘了" | 立即用 `edit` 追加 |
| **重要事件发生** | 做了重大决策、出现情绪变化 | AI 判断后用 `edit` 追加 |
| **承诺/待办** | AI 答应了事情 | 追加到"待办与承诺"部分 |
| **会话结束前** | 一段长对话即将结束 | 回顾对话，提炼关键信息写入 |

### AI 何时整理 MEMORY.md

随着使用时间增长，MEMORY.md 会越来越大。需要定期整理：

| 整理方式 | 说明 |
|----------|------|
| **合并重复** | 多条类似记录合并为一条 |
| **移除过时** | 已完成的待办、已过期的事件 |
| **提炼摘要** | 一周的细碎记录提炼为一段总结 |
| **标记时间** | 每条记忆带上日期，方便判断时效性 |

### 不应该记的

- ❌ 每句对话原文（不是聊天记录，是记忆）
- ❌ 敏感隐私信息（密码、金融信息等）
- ❌ 琐碎无意义的闲聊（"今天天气不错" 除非有特殊意义）

## 容量管理

### 为什么需要容量管理

MEMORY.md 全文注入 system prompt，过大会：
- 消耗大量 token 预算
- 稀释重要信息的权重
- 增加 API 成本

### 容量策略

| 策略 | 说明 |
|------|------|
| **软上限** | 建议保持在 5000 字符以内 |
| **截断保护** | 超过上限时自动截断（保留头 70% + 尾 20%） |
| **整理提示** | 接近上限时，AI 在下次对话中主动整理 |
| **配置可调** | 用户可通过配置调整上限 |

### 进阶方案（未来）

当前方案（v1）是全文注入，简单可靠。未来可渐进增强：

| 阶段 | 方案 | 优势 |
|------|------|------|
| **v1（当前）** | 单文件全文注入 | 简单、可靠、零依赖 |
| **v2** | 每日记忆文件 `memory/YYYY-MM-DD.md` | 自动归档，便于管理 |
| **v3** | 向量索引 + 语义搜索 | 大量记忆场景下的精准检索 |

**v1 的原则：先把基础做对，不过度设计。**

## 读取与注入

- **读取时机**：每次对话轮次开始时（**仅记忆开启时**）
- **注入位置**：system prompt 的 `# 记忆` 部分
- **截断规则**：超过配置上限时截断（见"容量策略"）
- **记忆关闭时**：不读取、不注入、不注册 MEMORY.md 相关的 write/edit 工具
- **附加指令**（仅记忆 ON 时）：
  > "MEMORY.md 是你的长期记忆。在对话中遇到值得记住的信息时，用 edit 工具更新它。定期整理，保持精炼。不要记录敏感信息。"

## 操作示例

### 追加一条记忆

```
工具调用：edit
参数：
  path: "MEMORY.md"
  oldText: "## 重要事件\n\n<!-- 值得记住的事情 -->"
  newText: "## 重要事件\n\n<!-- 值得记住的事情 -->\n\n- 2026-02-13：主人说周五有重要面试，需要准备"
```

### 标记待办完成

```
工具调用：edit
参数：
  path: "MEMORY.md"
  oldText: "- 提醒主人周五准备面试"
  newText: "- ✅ 已提醒主人准备面试（2026-02-14）"
```

## 安全约束

- 不记录密码、密钥等敏感信息
- 用户说"忘了这个"时立即删除对应内容
- 文件缺失时不自动创建（MEMORY.md 是可选的，不是必需的）
- AI 不应该为了"记住更多"而写流水账
