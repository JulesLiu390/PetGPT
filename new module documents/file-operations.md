# 文件读写模块 — 内置 write/edit 工具设计

## 概述

本模块定义了软件 **内置的文件操作工具**，供 LLM 通过 function calling 调用。

核心工具有三个：`read`、`write`、`edit`。它们作为 function calling 的 tool 注册给 LLM，当 LLM 决定要读写文件时，会生成对应的 tool call，由软件本地执行。

## 工具一览

| 工具 | 功能 | 操作特性 |
|------|------|----------|
| **read** | 读取文件内容 | 只读，安全 |
| **write** | 创建或整体覆盖文件 | 覆盖写，自动创建目录 |
| **edit** | 精确查找替换文件局部内容 | 局部修改，不影响其他内容 |

## read 工具

### 功能

读取指定文件的内容并返回给 LLM。

### 参数定义

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | 是 | 文件路径（相对于工作区根目录） |

### 返回

文件的文本内容。文件不存在时返回错误信息。

### 行为

1. 将相对路径解析为绝对路径（基于工作区根目录）
2. 路径安全检查（不能逃逸出工作区）
3. 读取文件内容（UTF-8）
4. 返回内容

## write 工具

### 功能

创建新文件或覆盖已有文件。自动创建不存在的父目录。

### 参数定义

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | 是 | 文件路径（相对于工作区根目录） |
| `content` | string | 是 | 要写入的完整内容 |

### 返回

成功：`"成功写入 N 字节到 path"`
失败：错误信息

### 行为

1. 将相对路径解析为绝对路径
2. 路径安全检查
3. 创建父目录（如果不存在）
4. 写入文件（UTF-8，覆盖模式）
5. 返回结果

### 使用场景

- 首次创建 SOUL.md / USER.md / MEMORY.md
- 需要完全重写文件内容时
- 创建全新文件时

## edit 工具

### 功能

通过精确的查找替换修改文件的局部内容。`oldText` 必须精确匹配文件中的内容，然后被替换为 `newText`。

### 参数定义

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | 是 | 文件路径（相对于工作区根目录） |
| `oldText` | string | 是 | 要查找的精确文本 |
| `newText` | string | 是 | 替换后的新文本 |

### 返回

成功：`"成功替换了 path 中的文本"`
失败：错误信息（找不到文本 / 多个匹配 / 文件不存在）

### 行为

1. 将相对路径解析为绝对路径
2. 路径安全检查
3. 读取文件全文
4. 查找 `oldText`：
   - 先精确匹配
   - 精确失败时尝试模糊匹配（容忍空白差异）
5. **唯一性检查** — 如果匹配到多处，返回错误，要求 LLM 提供更多上下文
6. 执行替换
7. **空操作检查** — 如果替换后内容没有变化，返回错误
8. 写回文件
9. 返回结果

### 使用场景

- 更新 USER.md 中的某个字段
- 向 MEMORY.md 追加一条记忆
- 修改 SOUL.md 中的某个性格描述
- 标记 MEMORY.md 中的待办为已完成

## 路径安全

所有文件操作必须限制在工作区目录内：

```
允许：
  SOUL.md          → ~/.app/workspace/SOUL.md ✅
  USER.md          → ~/.app/workspace/USER.md ✅
  memory/today.md  → ~/.app/workspace/memory/today.md ✅

拒绝：
  ../../../etc/passwd  → 路径逃逸 ❌
  /etc/hosts           → 绝对路径逃逸 ❌
  ../../secrets.txt    → 工作区外 ❌
```

### 安全检查逻辑

1. 将路径解析为绝对路径
2. 规范化路径（消除 `..`、`./` 等）
3. 确认解析后的路径以工作区根目录开头
4. 不满足则拒绝操作并返回错误

## 操作权限配置

可以按文件配置不同的操作权限：

| 文件 | read | write | edit | 说明 |
|------|------|-------|------|------|
| SOUL.md | ✅ | ✅（需确认） | ✅（需确认） | AI 修改需用户确认，**不受记忆开关影响** |
| USER.md | ✅ | ✅ | ✅ | AI 可自由读写，**仅记忆 ON 时可用** |
| MEMORY.md | ✅ | ✅ | ✅ | AI 可自由读写，**仅记忆 ON 时可用** |

### 记忆开关对工具注册的影响

| 记忆开关 | SOUL.md 工具 | USER.md 工具 | MEMORY.md 工具 |
|----------|-------------|-------------|---------------|
| **ON** | read ✅ / write ✅（需确认） / edit ✅（需确认） | read ✅ / write ✅ / edit ✅ | read ✅ / write ✅ / edit ✅ |
| **OFF** | read ✅ / write ✅（需确认） / edit ✅（需确认） | ❌ 不注册 | ❌ 不注册 |

记忆关闭时，LLM 的 function calling 中 **不包含** USER.md/MEMORY.md 相关的工具定义，AI 无法调用这些工具。
SOUL.md 的工具始终注册（但写入需要用户确认），因为人格不受记忆开关影响。

"需确认"的实现：

- AI 发起 write/edit SOUL.md 时
- 工具执行器暂停执行
- 弹出确认对话框展示变更内容
- 用户确认后才实际写入
- 用户拒绝则返回"用户拒绝了修改"给 LLM

## Function Calling 注册

将三个工具注册为 LLM 的 function/tool 定义：

```
工具名: read
描述: 读取工作区中的文件内容
参数:
  path (string, 必填): 文件路径（相对于工作区根目录）

工具名: write
描述: 创建或覆盖文件。自动创建父目录。
参数:
  path (string, 必填): 文件路径（相对于工作区根目录）
  content (string, 必填): 要写入的完整内容

工具名: edit
描述: 通过精确文本查找替换来编辑文件。oldText 必须精确匹配。
参数:
  path (string, 必填): 文件路径（相对于工作区根目录）
  oldText (string, 必填): 要查找并替换的精确文本（必须唯一匹配）
  newText (string, 必填): 替换后的新文本
```

## 错误处理

| 错误 | 触发条件 | 返回给 LLM 的消息 |
|------|----------|-------------------|
| 文件不存在 | read/edit 的目标文件不存在 | "文件不存在: {path}" |
| 路径不安全 | 路径逃逸出工作区 | "不允许访问工作区外的文件" |
| 文本未找到 | edit 的 oldText 在文件中不存在 | "无法在 {path} 中找到指定文本。请确保文本精确匹配。" |
| 多重匹配 | edit 的 oldText 匹配到多处 | "找到 {N} 处匹配。请提供更多上下文使其唯一。" |
| 空操作 | edit 替换后内容未变化 | "替换后内容没有变化。" |
| 用户拒绝 | SOUL.md 修改被用户拒绝 | "用户拒绝了此次修改。" |
